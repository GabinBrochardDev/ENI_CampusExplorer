{% extends 'base.html.twig' %}
 
{% block title %}Accueil - Sortir{% endblock %}
 
{% block body %}
<div class="container mx-auto p-4">
    <!-- Filter Section -->
    <div class="mt-6 p-8  rounded-xl shadow-lg border border-white bg-white">
        <h2 class="font-bold text-2xl mb-6 ">Filtrer les sorties</h2>
        <form method="get" action="{{ path('home') }}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Campus Filter -->
                <div class="flex flex-col">
                    <label for="campus" class="font-semibold ">Campus</label>
                    <select id="campus" name="campus" class="border border-gray-300 p-2 text-gray-800 rounded-lg focus:ring focus:ring-gray-200 shadow-sm">
                        <option value="">Tous</option>
                        {% for campus in campuses %}
                            <option  value="{{ campus.id }}" {{ campus.id == app.request.get('campus') ? 'selected' : '' }}>
                                {{ campus.nom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
 
                <!-- Search Filter -->
                <div class="flex flex-col">
                    <label for="search" class="font-semibold ">Le nom de la sortie contient</label>
                    <input type="text" id="search" name="search" class="border border-gray-300 text-gray-800 p-2 rounded-lg focus:ring focus:ring-gray-200 shadow-sm" value="{{ app.request.get('search') }}">
                </div>
 
                <!-- Date Filter -->
                <div class="flex flex-col">
                    <label class="font-semibold ">Entre</label>
                    <div class="flex space-x-2 ">
                        <input type="date" name="start_date" class="border border-gray-300 p-2 rounded-lg focus:ring focus:ring-gray-200 shadow-sm" value="{{ app.request.get('start_date') }}">
                        <span class="">et</span>
                        <input type="date" name="end_date" class="border border-gray-300 p-2 rounded-lg focus:ring focus:ring-gray-200 shadow-sm" value="{{ app.request.get('end_date') }}">
                    </div>
                </div>
            </div>
 
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 mt-6">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="organisateur" name="organisateur" {{ app.request.get('organisateur') ? 'checked' : '' }} class="shadow-sm">
                    <label for="organisateur" class="">Sorties dont je suis l'organisateur/trice</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="inscrit" name="inscrit" {{ app.request.get('inscrit') ? 'checked' : '' }} class="shadow-sm">
                    <label for="inscrit" class="">Sorties auxquelles je suis inscrit/e</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="non-inscrit" name="non-inscrit" {{ app.request.get('non-inscrit') ? 'checked' : '' }} class="shadow-sm">
                    <label for="non-inscrit" class="">Sorties auxquelles je ne suis pas inscrit/e</label>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="terminees" name="terminees" {{ app.request.get('terminees') ? 'checked' : '' }} class="shadow-sm">
                    <label for="terminees" class="">Sorties terminées</label>
                </div>
            </div>
 
            <button type="submit" class="mt-6 hover:bg-gary-200 bg-[#2C2C2C] text-white font-semibold px-6 py-2 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring focus:ring-gray-300 transition duration-300 ease-in-out transform hover:scale-105">
                Rechercher
            </button>
        </form>
    </div>
 
    <!-- Table Section -->
    <div class="mt-16 p-6 rounded-lg shadow-lg  border-white bg-white">
    <div class="overflow-y-auto max-h-96">
            <table class="min-w-full table-auto">
            <thead class="bg-[#2C2C2C] text-white shadow-lg sticky top-0 z-10">
                <tr class="text-left">
                    <th class="p-4 min-w-[150px] rounded-tl-lg">Nom de la sortie</th>
                    <th class="p-4 min-w-[120px]">Date de la sortie</th>
                    <th class="p-4 min-w-[120px]">Clôture</th>
                    <th class="p-4 min-w-[100px]">Inscrits/Places</th>
                    <th class="p-4 min-w-[100px]">Etat</th>
                    <th class="p-4 min-w-[80px]">Inscrit</th>
                    <th class="p-4 min-w-[150px]">Organisateur</th>
                    <th class="p-4 min-w-[150px] rounded-tr-lg text-center">Actions</th>
                </tr>
            </thead>
 
            <tbody>
                {% for sortie in sorties %}
                    <tr class="border-b hover:bg-[#F3F4F6]">
                        <td class="p-2 whitespace-normal break-words">{{ sortie.nom }}</td>
                        <td class="p-2">{{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y') : '' }}</td>
                        <td class="p-2">{{ sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('d/m/Y') : '' }}</td>
                        <td class="p-2">{{ sortie.estinscrit|length }}/{{ sortie.nbInscriptionMax }}</td>
                        <td class="p-2">{{ sortie.etat ? sortie.etat.libelle : '' }}</td>
             
                        <td class="p-2">{{ sortie.estinscrit.contains(app.user) ? 'X' : '' }}</td>
                        <td class="p-2 text-gray-600 hover:underline">
                            <a href="{{ path('app_participant_detail', {'id': sortie.organisateur.id}) }}">{{ sortie.organisateur.nom }}</a>
                        </td>
                        <td class="p-2 whitespace-normal break-words">
                           
                            {% if sortie.etat.libelle == 'Annulée' %}
                            <div class="flex space-x-2">
                                <a href="{{ path('sortie_afficher', {'id': sortie.id}) }}" class="bg-transparent text-[#2C2C2C] border border-[#2C2C2C] px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                    Afficher
                                </a>
                                </div>
                            {% else %}
                                {% if sortie.organisateur == app.user %}
                                {# PARTIE ORGANISATEUR #}
                                    <div class="flex space-x-2">
                                        {% if sortie.etat.libelle == 'Clôturée' %}
                                            <a href="{{ path('sortie_afficher', {'id': sortie.id}) }}" class="bg-transparent text-[#2C2C2C] border border-[#2C2C2C] px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                Afficher
                                            </a>
                                        {% else %}
                                            {% if sortie.etat.libelle != 'Ouverte'  %}
                                            {# bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 #}
                                                <a href="{{ path('sortie_modifier', {'id': sortie.id}) }}" class="bg-transparent text-yellow-500 border border-yellow-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                    Modifier
                                                </a>
                                            {% endif %}
                                            {% if sortie.etat.libelle == 'En création' %}
                                                <a href="{{ path('sortie_publier', {'id': sortie.id}) }}" class="bg-transparent text-green-500 border border-green-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                    Publier
                                                </a>
                                                <a href="{{ path('sortie_supprimer', {'id': sortie.id}) }}" class="bg-transparent text-red-500 border border-red-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center"
                                                onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette sortie ?');">
                                                    Supprimer
                                                </a>
 
                                            {% elseif sortie.etat.libelle == 'Ouverte' %}
                                                <a href="{{ path('sortie_afficher', {'id': sortie.id}) }}" class="bg-transparent text-[#2C2C2C] border border-[#2C2C2C] px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                    Afficher
                                                </a>
                                                {# bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 #}
                                                <a href="javascript:void(0);" class="bg-transparent text-yellow-500 border border-yellow-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center"
                                                onclick="openCancelModal('{{ sortie.id }}', '{{ sortie.nom }}', '{{ path('sortie_afficher', {'id': sortie.id}) }}', '{{ path('sortie_annuler', {'id': sortie.id}) }}');">
                                                    Annuler
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                {% else %}
                                {# PARTIE VISITEUR #}
                                    <div class="flex space-x-2">
                                        {% if sortie.etat.libelle != 'En création' %}
                                            <a href="{{ path('sortie_afficher', {'id': sortie.id}) }}" class="bg-transparent text-[#2C2C2C] border border-[#2C2C2C] px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                Afficher
                                            </a>
                                        {% endif %}
                                        {% if sortie.estinscrit.contains(app.user) %}
                                            <a href="{{ path('sortie_desister', {'id': sortie.id}) }}" class="bg-transparent text-red-500 border border-red-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                Se désister
                                            </a>
                                        {% elseif sortie.etat.libelle == 'Ouverte' and sortie.estinscrit|length < sortie.nbInscriptionMax %}
                                            <a href="{{ path('sortie_inscrire', {'id': sortie.id}) }}" class="bg-transparent text-green-500 border border-green-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center">
                                                S'inscrire
                                            </a>
                                        {% endif %}
                                        {% if is_granted('ROLE_ADMIN') and sortie.etat.libelle != 'Annulée' and sortie.etat.libelle != 'En création' %}
                                            <a href="javascript:void(0);" class="bg-transparent text-yellow-500 border border-yellow-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 w-28 text-center"
                                            onclick="openCancelModal('{{ sortie.id }}', '{{ sortie.nom }}', '{{ path('sortie_afficher', {'id': sortie.id}) }}', '{{ path('sortie_annuler', {'id': sortie.id}) }}');">
                                                Annuler
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center p-4">Aucune sortie disponible</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {# mt-6 hover:bg-gary-200 bg-[#2C2C2C] text-white font-semibold px-6 py-2 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring focus:ring-gray-300 transition duration-300 ease-in-out transform hover:scale-105 #}
            <div class="relative">
                <div class="sticky bottom-0 mt-6">
                    <a href="{{ path('sortie_create') }}" class="hover:bg-gray-200 bg-[#2C2C2C] text-white px-6 py-2 rounded-lg shadow-lg font-bold hover:shadow-xl transition duration-300 ease-in-out transform hover:scale-105">
                        Créer une sortie
                    </a>
                </div>
            </div>
</div>
 
        </div>
    </div>
</div>
 
<!-- Modal for Annulation -->
<div id="cancelModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
      <h3 class="text-lg font-medium text-gray-900" id="modal-title">Annuler la sortie</h3>
      <form id="cancelForm" method="post" action="">
        <div class="mt-4">
          <p class="text-sm text-gray-500" id="recap"></p>
          <label for="motif" class="block text-sm font-medium text-gray-700 mt-4">Motif de l'annulation</label>
          <textarea id="motif" name="motif" rows="3" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md" placeholder="Motif de l'annulation"></textarea>
        </div>
        <div class="mt-6 flex justify-end">
          <button type="button" class="bg-transparent text-[#2C2C2C] border border-[#2C2C2C] px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105 mr-2" onclick="closeModal()">Annuler</button>
          <button type="submit" class="bg-transparent text-yellow-500 border border-yellow-500 px-4 py-2 rounded  transition duration-300 ease-in-out transform hover:scale-105">Confirmer l'annulation</button>
        </div>
      </form>
    </div>
  </div>
</div>
 
<script>
    function openCancelModal(id, name, recapUrl, submitUrl) {
        document.getElementById('recap').innerHTML = "Êtes-vous sûr de vouloir annuler la sortie : " + name + " ?";
        document.getElementById('cancelForm').action = submitUrl;
        document.getElementById('cancelModal').classList.remove('hidden');
    }
 
    function closeModal() {
        document.getElementById('cancelModal').classList.add('hidden');
    }
</script>
 
{% endblock %}